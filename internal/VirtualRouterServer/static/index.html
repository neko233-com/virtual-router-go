<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Virtual Router Monitor</title>
  <link rel="stylesheet" href="/app.css" />
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <div class="brand">Virtual Router</div>
      <div class="login-box">
        <input id="password" type="password" value="root" placeholder="管理员密码" />
        <button id="loginBtn">登录</button>
        <button id="refreshBtn" disabled>手动刷新</button>
        <p id="loginMsg" class="msg"></p>
      </div>
      <nav class="tabs" id="tabs">
        <button class="tab active" data-tab="home">首页</button>
        <button class="tab" data-tab="rpc">RPC节点列表</button>
        <button class="tab" data-tab="rpc-traffic">RPC 流量管理</button>
        <button class="tab" data-tab="logs">日志</button>
        <button class="tab" data-tab="settings">系统设置</button>
      </nav>
    </aside>

    <main class="content">
      <section class="panel active" id="tab-home">
        <h1>首页</h1>
        <div class="stats" id="stats"></div>
        <div class="chart-grid">
          <div class="card chart-card">
            <h2>每分钟请求趋势（RPM）</h2>
            <div id="requestChart" class="chart"></div>
          </div>
          <div class="card chart-card">
            <h2>内存占用</h2>
            <div id="memoryChart" class="chart"></div>
          </div>
          <div class="card chart-card">
            <h2>连接与在线路由</h2>
            <div id="onlineChart" class="chart"></div>
          </div>
          <div class="card chart-card">
            <h2>内存使用率趋势</h2>
            <div id="memoryUsageTrendChart" class="chart"></div>
          </div>
          <div class="card chart-card">
            <h2>节点国家分布</h2>
            <div id="countryDistChart" class="chart"></div>
          </div>
          <div class="card chart-card">
            <h2>RPC 模式分布</h2>
            <div id="modeDistChart" class="chart"></div>
          </div>
          <div class="card chart-card">
            <h2>节点 Stub 数 Top10</h2>
            <div id="stubTopChart" class="chart"></div>
          </div>
        </div>
      </section>

      <section class="panel" id="tab-rpc">
        <h1>RPC节点列表</h1>
        <div class="card">
          <div class="row">
            <label for="routerKeyword">搜索 routerId</label>
            <input id="routerKeyword" type="text" placeholder="输入关键字过滤路由节点" />
            <button id="searchRoutersBtn" disabled>查询</button>
          </div>
          <h2>在线节点</h2>
          <table>
            <thead>
              <tr>
                <th>RouteId</th>
                <th>上次心跳</th>
                <th>来源 IP:Port</th>
                <th>国家/地区</th>
                <th>归属地</th>
                <th>运营商/组织</th>
                <th>模式</th>
                <th>RPC 注册地址</th>
                <th>Stub 数</th>
                <th>状态</th>
              </tr>
            </thead>
            <tbody id="routersBody"></tbody>
          </table>
        </div>
        <div class="card">
          <h2>RPC 调试</h2>
          <p class="subtle">调试发送已改为独立窗口，避免和节点列表混在一起。</p>
          <button id="openRpcDebugBtn" disabled>打开 RPC 调试窗口</button>
        </div>
      </section>

      <section class="panel" id="tab-rpc-traffic">
        <h1>RPC 流量管理</h1>
        <div class="card">
          <div class="row">
            <label for="rpcTrafficKeyword">搜索 routerId</label>
            <input id="rpcTrafficKeyword" type="text" placeholder="按 routerId 查询排行" />
            <button id="searchRpcTrafficBtn" disabled>查询</button>
          </div>
        </div>
        <div class="card chart-card">
          <h2>RPC 频率排行榜（每分钟）</h2>
          <div id="rpcRankChart" class="chart"></div>
        </div>
        <div class="card">
          <h2>详细排行</h2>
          <table>
            <thead>
              <tr>
                <th>排名</th>
                <th>RouterId</th>
                <th>每分钟</th>
                <th>总量</th>
                <th>入站</th>
                <th>出站</th>
              </tr>
            </thead>
            <tbody id="rpcRankBody"></tbody>
          </table>
        </div>
      </section>

      <section class="panel" id="tab-logs">
        <h1>日志</h1>
        <div class="card">
          <div class="row">
            <label for="logLimit">条数</label>
            <input id="logLimit" type="number" min="10" max="1000" value="200" />
            <label for="logKeyword">关键字</label>
            <input id="logKeyword" type="text" placeholder="可选，支持模糊匹配" />
            <label for="logLevel">级别</label>
            <select id="logLevel">
              <option value="all">全部</option>
              <option value="info">Info</option>
              <option value="warn">Warn</option>
              <option value="error">Error</option>
            </select>
            <label class="switch-inline" for="logAutoRefresh">
              <input id="logAutoRefresh" type="checkbox" checked />
              自动刷新
            </label>
            <button id="loadLogsBtn" disabled>刷新日志</button>
            <button id="exportLogsBtn" disabled>导出 txt</button>
          </div>
          <pre id="logOutput" class="result">暂无日志</pre>
        </div>
      </section>

      <section class="panel" id="tab-settings">
        <h1>系统设置</h1>
        <div class="card">
          <h2>运行配置</h2>
          <div class="kv-list" id="settingsInfo"></div>
        </div>
        <div class="card">
          <h2>管理员密码</h2>
          <div class="row">
            <label for="oldPassword">旧密码</label>
            <input id="oldPassword" type="password" />
          </div>
          <div class="row">
            <label for="newPassword">新密码</label>
            <input id="newPassword" type="password" />
          </div>
          <div class="row">
            <label for="confirmPassword">确认新密码</label>
            <input id="confirmPassword" type="password" />
            <button id="updatePasswordBtn" disabled>更新密码</button>
          </div>
          <p id="settingsMsg" class="msg"></p>
        </div>
      </section>
    </main>
  </div>

  <div id="rpcDebugModal" class="modal hidden">
    <div class="modal-backdrop" id="rpcDebugBackdrop"></div>
    <div class="modal-panel">
      <div class="modal-header">
        <h2>RPC 调试发送</h2>
        <button id="closeRpcDebugBtn" class="danger">关闭</button>
      </div>
      <div class="row rpc-row">
        <label for="targetRouteId">目标 RouteId</label>
        <input id="targetRouteId" type="text" placeholder="例如: client-1" />

        <label for="packetId">PacketId</label>
        <input id="packetId" type="number" min="1" placeholder="例如: 1001" />

        <button id="loadStubsBtn" disabled>加载方法</button>
      </div>
      <div class="row rpc-row">
        <label for="stubSelect">可用方法</label>
        <select id="stubSelect" disabled>
          <option value="">请先加载方法</option>
        </select>
      </div>
      <div class="row rpc-row">
        <label for="paramText">参数(字符串)</label>
        <textarea id="paramText" rows="5" placeholder="可直接填写 JSON 字符串，作为方法参数 string 传递"></textarea>
      </div>
      <div class="row rpc-row">
        <button id="sendRpcBtn" disabled>发送 RPC</button>
        <span id="rpcMsg" class="msg"></span>
      </div>
      <pre id="rpcResult" class="result">暂无结果</pre>
    </div>
  </div>

  <script src="/app.js"></script>
</body>
</html>
